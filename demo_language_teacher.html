<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Teacher - Practice & Learn</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .chat-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .language-select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            background: white;
        }

        .language-select:focus {
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            color: #495057;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-messages {
            flex: 1;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .evaluation-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .score-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .score-circle {
            display: inline-block;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
        }

        .score-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .score-label {
            font-size: 0.9rem;
        }

        .evaluation-content {
            flex: 1;
            overflow-y: auto;
        }

        .evaluation-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .evaluation-section ul {
            list-style: none;
            padding-left: 0;
        }

        .evaluation-section li {
            background: #f8f9fa;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .mistake-item {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .mistake-original {
            color: #e53e3e;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .mistake-correction {
            color: #38a169;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .mistake-explanation {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #1976d2;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .demo-mode {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Language Teacher</h1>
            <p>Practice conversations and get detailed feedback on your language skills</p>
        </div>

        <div class="main-content">
            <!-- Chat Section -->
            <div class="chat-section">
                <div class="demo-mode">
                    <strong>Demo Mode:</strong> This is a demonstration version. Select a language and try the interface!
                </div>

                <div class="controls">
                    <select id="languageSelect" class="language-select">
                        <option value="">Select Language</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                        <option value="pt">Portuguese</option>
                        <option value="ru">Russian</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="zh">Chinese</option>
                    </select>
                    
                    <button id="newSessionBtn" class="btn btn-secondary" disabled>New Session</button>
                    <button id="evaluateBtn" class="btn btn-primary" disabled>Get Evaluation</button>
                </div>

                <div id="statusMessage" class="status-message">
                    Select a language and start a new session to begin chatting
                </div>

                <div id="chatMessages" class="chat-messages">
                    <!-- Messages will be added here -->
                </div>

                <div class="input-area">
                    <input type="text" id="messageInput" class="message-input" 
                           placeholder="Type your message here..." disabled>
                    <button id="sendBtn" class="btn btn-primary" disabled>Send</button>
                </div>
            </div>

            <!-- Evaluation Section -->
            <div class="evaluation-section">
                <div class="evaluation-header">
                    <h2>üìä Performance Evaluation</h2>
                </div>

                <div id="evaluationContent" class="evaluation-content">
                    <div class="loading">
                        Start a conversation and click "Get Evaluation" to see your performance analysis
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LanguageTeacherDemo {
            constructor() {
                this.currentSession = null;
                this.selectedLanguage = null;
                this.conversationHistory = [];
                
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.languageSelect = document.getElementById('languageSelect');
                this.newSessionBtn = document.getElementById('newSessionBtn');
                this.evaluateBtn = document.getElementById('evaluateBtn');
                this.statusMessage = document.getElementById('statusMessage');
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.evaluationContent = document.getElementById('evaluationContent');
            }

            bindEvents() {
                this.languageSelect.addEventListener('change', () => this.onLanguageSelected());
                this.newSessionBtn.addEventListener('click', () => this.newSession());
                this.evaluateBtn.addEventListener('click', () => this.requestEvaluation());
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            onLanguageSelected() {
                const selectedCode = this.languageSelect.value;
                if (selectedCode) {
                    const languageNames = {
                        'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German',
                        'it': 'Italian', 'pt': 'Portuguese', 'ru': 'Russian',
                        'ja': 'Japanese', 'ko': 'Korean', 'zh': 'Chinese'
                    };
                    
                    this.selectedLanguage = {
                        code: selectedCode,
                        name: languageNames[selectedCode]
                    };
                    
                    this.statusMessage.textContent = `Selected: ${this.selectedLanguage.name}. Click "New Session" to start chatting.`;
                    this.newSessionBtn.disabled = false;
                }
            }

            newSession() {
                if (!this.selectedLanguage) {
                    alert('Please select a language first!');
                    return;
                }

                try {
                    // Generate unique session ID
                    this.currentSession = 'demo-session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    this.conversationHistory = [];
                    
                    // Clear chat area
                    this.chatMessages.innerHTML = '';
                    
                    // Reset UI state
                    this.messageInput.value = '';
                    this.messageInput.disabled = false;
                    this.sendBtn.disabled = false;
                    this.evaluateBtn.disabled = false;
                    
                    // Update status message
                    this.statusMessage.textContent = `New session started! Start chatting in ${this.selectedLanguage.name}`;
                    
                    // Focus on input
                    this.messageInput.focus();
                    
                    // Add welcome message based on selected language
                    const welcomeMessages = {
                        'en': "Hello! I'm here to help you practice English. Let's start a conversation!",
                        'es': "¬°Hola! Estoy aqu√≠ para ayudarte a practicar espa√±ol. ¬°Empecemos una conversaci√≥n!",
                        'fr': "Bonjour ! Je suis l√† pour vous aider √† pratiquer le fran√ßais. Commen√ßons une conversation !",
                        'de': "Hallo! Ich bin hier, um Ihnen beim Deutschlernen zu helfen. Lassen Sie uns ein Gespr√§ch beginnen!",
                        'it': "Ciao! Sono qui per aiutarti a praticare l'italiano. Iniziamo una conversazione!",
                        'pt': "Ol√°! Estou aqui para ajud√°-lo a praticar portugu√™s. Vamos come√ßar uma conversa!",
                        'ru': "–ü—Ä–∏–≤–µ—Ç! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤–∞–º –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä!",
                        'ja': "„Åì„Çì„Å´„Å°„ÅØÔºÅÊó•Êú¨Ë™û„ÅÆÁ∑¥Áøí„Çí„ÅäÊâã‰ºù„ÅÑ„Åó„Åæ„Åô„ÄÇ‰ºöË©±„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ",
                        'ko': "ÏïàÎÖïÌïòÏÑ∏Ïöî! ÌïúÍµ≠Ïñ¥ Ïó∞ÏäµÏùÑ ÎèÑÏôÄÎìúÎ¶¨Í≤†ÏäµÎãàÎã§. ÎåÄÌôîÎ•º ÏãúÏûëÌï¥Î¥ÖÏãúÎã§!",
                        'zh': "‰Ω†Â•ΩÔºÅÊàëÊù•Â∏Æ‰Ω†ÁªÉ‰π†‰∏≠Êñá„ÄÇËÆ©Êàë‰ª¨ÂºÄÂßãÂØπËØùÂêßÔºÅ"
                    };
                    
                    const welcomeMessage = welcomeMessages[this.selectedLanguage.code] || welcomeMessages['en'];
                    this.addMessageToChat(welcomeMessage, "assistant");
                    
                    // Add welcome message to conversation history
                    this.conversationHistory.push({role: 'assistant', content: welcomeMessage});
                    
                    // Clear any previous evaluation
                    this.evaluationContent.innerHTML = `
                        <div class="loading">
                            Start a conversation and click "Get Evaluation" to see your performance analysis
                        </div>
                    `;
                    
                    console.log(`New session started: ${this.currentSession} for language: ${this.selectedLanguage.name}`);
                    
                } catch (error) {
                    console.error('Error starting new session:', error);
                    alert('Error starting new session. Please try again.');
                }
            }

            sendMessage() {
                try {
                    const message = this.messageInput.value.trim();
                    
                    // Validate input
                    if (!message) {
                        this.statusMessage.textContent = "Please type a message first!";
                        return;
                    }
                    
                    if (!this.currentSession) {
                        alert('Please start a new session first!');
                        return;
                    }
                    
                    if (!this.selectedLanguage) {
                        alert('Please select a language first!');
                        return;
                    }

                    // Add user message to chat
                    this.addMessageToChat(message, "user");
                    this.messageInput.value = '';

                    // Add to conversation history
                    this.conversationHistory.push({role: 'user', content: message});

                    // Show loading
                    this.statusMessage.textContent = "AI is thinking...";
                    this.sendBtn.disabled = true;
                    this.messageInput.disabled = true;

                    // Simulate AI response (demo mode) - Enhanced with conversation memory
                    setTimeout(() => {
                        try {
                            const smartResponse = this.getSmartResponse(message);
                            
                            if (smartResponse && typeof smartResponse === 'string') {
                                this.addMessageToChat(smartResponse, "assistant");
                                this.conversationHistory.push({role: 'assistant', content: smartResponse});
                            } else {
                                // Fallback response
                                const fallbackResponses = {
                                    'en': "That's interesting! Tell me more about that.",
                                    'es': "¬°Eso es interesante! Cu√©ntame m√°s sobre eso.",
                                    'fr': "C'est int√©ressant ! Parlez-moi plus de cela.",
                                    'de': "Das ist interessant! Erz√§hlen Sie mir mehr dar√ºber.",
                                    'it': "√à interessante! Dimmi di pi√π su questo.",
                                    'pt': "Isso √© interessante! Conte-me mais sobre isso.",
                                    'ru': "–≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ –±–æ–ª—å—à–µ –æ–± —ç—Ç–æ–º.",
                                    'ja': "„Åù„Çå„ÅØËààÂë≥Ê∑±„ÅÑ„Åß„ÅôÔºÅ„Åù„Çå„Å´„Å§„ÅÑ„Å¶„ÇÇ„Å£„Å®Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                                    'ko': "Ìù•ÎØ∏Î°≠ÎÑ§Ïöî! Í∑∏Í≤ÉÏóê ÎåÄÌï¥ Îçî ÏûêÏÑ∏Ìûà ÎßêÌï¥Ï£ºÏÑ∏Ïöî.",
                                    'zh': "ËøôÂæàÊúâË∂£ÔºÅÂëäËØâÊàëÊõ¥Â§öÂÖ≥‰∫éËøô‰∏™ÁöÑ‰ø°ÊÅØ„ÄÇ"
                                };
                                
                                const fallbackResponse = fallbackResponses[this.selectedLanguage.code] || fallbackResponses['en'];
                                this.addMessageToChat(fallbackResponse, "assistant");
                                this.conversationHistory.push({role: 'assistant', content: fallbackResponse});
                            }
                            
                            this.sendBtn.disabled = false;
                            this.messageInput.disabled = false;
                            this.statusMessage.textContent = `Ready to chat in ${this.selectedLanguage.name}`;
                            this.messageInput.focus();
                            
                        } catch (error) {
                            console.error('Error generating AI response:', error);
                            this.addMessageToChat("I'm sorry, I had trouble understanding that. Could you try again?", "assistant");
                            this.conversationHistory.push({role: 'assistant', content: "I'm sorry, I had trouble understanding that. Could you try again?"});
                            
                            this.sendBtn.disabled = false;
                            this.messageInput.disabled = false;
                            this.statusMessage.textContent = `Ready to chat in ${this.selectedLanguage.name}`;
                            this.messageInput.focus();
                        }
                    }, 1000 + Math.random() * 2000); // Random delay 1-3 seconds
                    
                } catch (error) {
                    console.error('Error in sendMessage:', error);
                    alert('Error sending message. Please try again.');
                    
                    // Reset UI state
                    this.sendBtn.disabled = false;
                    this.messageInput.disabled = false;
                    this.statusMessage.textContent = `Ready to chat in ${this.selectedLanguage.name}`;
                }
            }

            getSmartResponse(userMessage) {
                const message = userMessage.toLowerCase();
                const conversationLength = this.conversationHistory.length;
                
                // Enhanced response system with conversation memory
                const responses = {
                    'en': {
                        greeting: [
                            "Hello! Nice to meet you! What brings you here today?",
                            "Hi there! How are you doing today?",
                            "Hey! Great to chat with you. What's on your mind?",
                            "Hello! I'm excited to practice with you. What would you like to talk about?"
                        ],
                        work: [
                            "That's interesting! What kind of work do you do?",
                            "Work can be challenging sometimes. How do you like your job?",
                            "Tell me more about your work experience!",
                            "That sounds like a great career! What's the best part of your job?"
                        ],
                        family: [
                            "Family is so important! Tell me about your family.",
                            "That sounds wonderful! How many people are in your family?",
                            "I'd love to hear more about your family life.",
                            "Family relationships are so special. What's your favorite family memory?"
                        ],
                        travel: [
                            "Traveling is amazing! Where have you been recently?",
                            "That sounds like an incredible trip! What was your favorite part?",
                            "I love hearing travel stories! Tell me more about your adventures.",
                            "Travel broadens the mind! What's the most interesting place you've visited?"
                        ],
                        food: [
                            "Food is one of life's great pleasures! What's your favorite cuisine?",
                            "That sounds delicious! Do you like to cook?",
                            "I'm getting hungry just hearing about it! What's your go-to meal?",
                            "Cooking is such a wonderful skill! What's your signature dish?"
                        ],
                        hobby: [
                            "That's a great hobby! How long have you been doing that?",
                            "Hobbies are so important for relaxation. What got you interested in that?",
                            "That sounds really fun! Do you do it regularly?",
                            "Having hobbies makes life more interesting! What do you enjoy most about it?"
                        ],
                        weather: [
                            "The weather affects us all! How do you like the current season?",
                            "Weather can really influence our mood. What's your favorite type of weather?",
                            "I agree! The weather has been quite something lately.",
                            "Weather is so unpredictable! Do you prefer hot or cold weather?"
                        ],
                        feelings: [
                            "I understand how you feel. That must be challenging.",
                            "That sounds really tough. How are you coping with that?",
                            "I'm sorry to hear that. Would you like to talk about it more?",
                            "That's a lot to deal with. You're being very brave."
                        ],
                        questions: [
                            "That's a great question! Let me think about that...",
                            "Hmm, that's interesting. I've never thought about it that way.",
                            "That's a thoughtful question. What made you think of that?",
                            "I'm not sure about that. What do you think?"
                        ],
                        default: [
                            "That's really interesting! Tell me more about that.",
                            "I see! How do you feel about that?",
                            "That sounds fascinating! What made you think of that?",
                            "Wow, that's quite something! Can you elaborate?",
                            "I'm curious about that! What's your experience been like?",
                            "That's amazing! How did that make you feel?",
                            "I'd love to hear more details about that!",
                            "That sounds like quite an experience! What happened next?"
                        ]
                    },
                    'es': {
                        greeting: [
                            "¬°Hola! ¬°Mucho gusto conocerte! ¬øQu√© te trae por aqu√≠ hoy?",
                            "¬°Hola! ¬øC√≥mo est√°s hoy?",
                            "¬°Hey! Es genial charlar contigo. ¬øEn qu√© est√°s pensando?",
                            "¬°Hola! Estoy emocionado de practicar contigo. ¬øDe qu√© te gustar√≠a hablar?"
                        ],
                        work: [
                            "¬°Eso es interesante! ¬øQu√© tipo de trabajo haces?",
                            "El trabajo puede ser desafiante a veces. ¬øTe gusta tu trabajo?",
                            "¬°Cu√©ntame m√°s sobre tu experiencia laboral!",
                            "¬°Eso suena como una gran carrera! ¬øCu√°l es la mejor parte de tu trabajo?"
                        ],
                        family: [
                            "¬°La familia es tan importante! Cu√©ntame sobre tu familia.",
                            "¬°Eso suena maravilloso! ¬øCu√°ntas personas hay en tu familia?",
                            "Me encantar√≠a escuchar m√°s sobre tu vida familiar.",
                            "Las relaciones familiares son tan especiales. ¬øCu√°l es tu recuerdo familiar favorito?"
                        ],
                        travel: [
                            "¬°Viajar es incre√≠ble! ¬øD√≥nde has estado recientemente?",
                            "¬°Eso suena como un viaje incre√≠ble! ¬øCu√°l fue tu parte favorita?",
                            "¬°Me encanta escuchar historias de viajes! Cu√©ntame m√°s sobre tus aventuras.",
                            "¬°Viajar ampl√≠a la mente! ¬øCu√°l es el lugar m√°s interesante que has visitado?"
                        ],
                        food: [
                            "¬°La comida es uno de los grandes placeres de la vida! ¬øCu√°l es tu cocina favorita?",
                            "¬°Eso suena delicioso! ¬øTe gusta cocinar?",
                            "¬°Me est√° dando hambre solo escucharlo! ¬øCu√°l es tu comida favorita?",
                            "¬°Cocinar es una habilidad tan maravillosa! ¬øCu√°l es tu plato especialidad?"
                        ],
                        hobby: [
                            "¬°Ese es un gran pasatiempo! ¬øCu√°nto tiempo llevas haci√©ndolo?",
                            "Los pasatiempos son tan importantes para relajarse. ¬øQu√© te interes√≥ en eso?",
                            "¬°Eso suena muy divertido! ¬øLo haces regularmente?",
                            "¬°Tener pasatiempos hace la vida m√°s interesante! ¬øQu√© disfrutas m√°s de eso?"
                        ],
                        weather: [
                            "¬°El clima nos afecta a todos! ¬øC√≥mo te gusta la temporada actual?",
                            "El clima puede influir mucho en nuestro estado de √°nimo. ¬øCu√°l es tu tipo de clima favorito?",
                            "¬°Estoy de acuerdo! El clima ha estado bastante loco √∫ltimamente.",
                            "¬°El clima es tan impredecible! ¬øPrefieres el clima caliente o fr√≠o?"
                        ],
                        feelings: [
                            "Entiendo c√≥mo te sientes. Eso debe ser desafiante.",
                            "Eso suena realmente dif√≠cil. ¬øC√≥mo est√°s manejando eso?",
                            "Lamento escuchar eso. ¬øTe gustar√≠a hablar m√°s sobre eso?",
                            "Eso es mucho con lo que lidiar. Est√°s siendo muy valiente."
                        ],
                        questions: [
                            "¬°Esa es una gran pregunta! D√©jame pensar en eso...",
                            "Hmm, eso es interesante. Nunca lo hab√≠a pensado de esa manera.",
                            "Esa es una pregunta reflexiva. ¬øQu√© te hizo pensar en eso?",
                            "No estoy seguro de eso. ¬øQu√© piensas t√∫?"
                        ],
                        default: [
                            "¬°Eso es realmente interesante! Cu√©ntame m√°s sobre eso.",
                            "¬°Ya veo! ¬øC√≥mo te sientes al respecto?",
                            "¬°Eso suena fascinante! ¬øQu√© te hizo pensar en eso?",
                            "¬°Wow, eso es bastante impresionante! ¬øPuedes elaborar?",
                            "¬°Tengo curiosidad sobre eso! ¬øC√≥mo ha sido tu experiencia?",
                            "¬°Eso es incre√≠ble! ¬øC√≥mo te hizo sentir eso?",
                            "¬°Me encantar√≠a escuchar m√°s detalles sobre eso!",
                            "¬°Eso suena como toda una experiencia! ¬øQu√© pas√≥ despu√©s?"
                        ]
                    },
                    'fr': {
                        greeting: [
                            "Bonjour ! Ravi de vous rencontrer ! Qu'est-ce qui vous am√®ne ici aujourd'hui ?",
                            "Salut ! Comment allez-vous aujourd'hui ?",
                            "Salut ! C'est g√©nial de discuter avec vous. √Ä quoi pensez-vous ?",
                            "Bonjour ! Je suis ravi de pratiquer avec vous. De quoi aimeriez-vous parler ?"
                        ],
                        work: [
                            "C'est int√©ressant ! Quel genre de travail faites-vous ?",
                            "Le travail peut √™tre difficile parfois. Aimez-vous votre travail ?",
                            "Parlez-moi plus de votre exp√©rience professionnelle !",
                            "Cela semble √™tre une excellente carri√®re ! Quelle est la meilleure partie de votre travail ?"
                        ],
                        family: [
                            "La famille est si importante ! Parlez-moi de votre famille.",
                            "Cela semble merveilleux ! Combien de personnes y a-t-il dans votre famille ?",
                            "J'aimerais entendre plus sur votre vie de famille.",
                            "Les relations familiales sont si sp√©ciales. Quel est votre souvenir familial pr√©f√©r√© ?"
                        ],
                        travel: [
                            "Voyager est incroyable ! O√π √™tes-vous all√© r√©cemment ?",
                            "Cela semble √™tre un voyage incroyable ! Quelle √©tait votre partie pr√©f√©r√©e ?",
                            "J'adore entendre des histoires de voyage ! Parlez-moi plus de vos aventures.",
                            "Voyager √©largit l'esprit ! Quel est l'endroit le plus int√©ressant que vous ayez visit√© ?"
                        ],
                        food: [
                            "La nourriture est l'un des grands plaisirs de la vie ! Quelle est votre cuisine pr√©f√©r√©e ?",
                            "Cela semble d√©licieux ! Aimez-vous cuisiner ?",
                            "J'ai faim rien qu'en l'entendant ! Quel est votre plat pr√©f√©r√© ?",
                            "Cuisiner est une comp√©tence si merveilleuse ! Quel est votre plat signature ?"
                        ],
                        hobby: [
                            "C'est un excellent passe-temps ! Depuis combien de temps le faites-vous ?",
                            "Les passe-temps sont si importants pour se d√©tendre. Qu'est-ce qui vous a int√©ress√© √† cela ?",
                            "Cela semble vraiment amusant ! Le faites-vous r√©guli√®rement ?",
                            "Avoir des passe-temps rend la vie plus int√©ressante ! Qu'est-ce que vous appr√©ciez le plus ?"
                        ],
                        weather: [
                            "Le temps nous affecte tous ! Comment aimez-vous la saison actuelle ?",
                            "Le temps peut vraiment influencer notre humeur. Quel est votre type de temps pr√©f√©r√© ?",
                            "Je suis d'accord ! Le temps a √©t√© assez fou r√©cemment.",
                            "Le temps est si impr√©visible ! Pr√©f√©rez-vous le temps chaud ou froid ?"
                        ],
                        feelings: [
                            "Je comprends comment vous vous sentez. Cela doit √™tre difficile.",
                            "Cela semble vraiment difficile. Comment g√©rez-vous cela ?",
                            "Je suis d√©sol√© d'entendre cela. Voudriez-vous en parler davantage ?",
                            "C'est beaucoup √† g√©rer. Vous √™tes tr√®s courageux."
                        ],
                        questions: [
                            "C'est une excellente question ! Laissez-moi r√©fl√©chir √† cela...",
                            "Hmm, c'est int√©ressant. Je n'y avais jamais pens√© de cette fa√ßon.",
                            "C'est une question r√©fl√©chie. Qu'est-ce qui vous a fait penser √† cela ?",
                            "Je ne suis pas s√ªr de cela. Qu'en pensez-vous ?"
                        ],
                        default: [
                            "C'est vraiment int√©ressant ! Parlez-moi plus de cela.",
                            "Je vois ! Comment vous sentez-vous √† ce sujet ?",
                            "Cela semble fascinant ! Qu'est-ce qui vous a fait penser √† cela ?",
                            "Wow, c'est assez impressionnant ! Pouvez-vous √©laborer ?",
                            "Je suis curieux √† ce sujet ! Comment a √©t√© votre exp√©rience ?",
                            "C'est incroyable ! Comment cela vous a-t-il fait sentir ?",
                            "J'aimerais entendre plus de d√©tails √† ce sujet !",
                            "Cela semble √™tre toute une exp√©rience ! Qu'est-il arriv√© ensuite ?"
                        ]
                    }
                };

                const languageResponses = responses[this.selectedLanguage.code] || responses['en'];
                
                // Determine context based on keywords and conversation history
                let context = 'default';
                
                if (message.includes('hello') || message.includes('hi') || message.includes('hey')) {
                    context = 'greeting';
                } else if (message.includes('work') || message.includes('job') || message.includes('office') || message.includes('career')) {
                    context = 'work';
                } else if (message.includes('family') || message.includes('mother') || message.includes('father') || message.includes('sister') || message.includes('brother') || message.includes('parents')) {
                    context = 'family';
                } else if (message.includes('travel') || message.includes('trip') || message.includes('vacation') || message.includes('visit') || message.includes('country')) {
                    context = 'travel';
                } else if (message.includes('food') || message.includes('eat') || message.includes('cook') || message.includes('restaurant') || message.includes('meal')) {
                    context = 'food';
                } else if (message.includes('hobby') || message.includes('sport') || message.includes('music') || message.includes('read') || message.includes('game')) {
                    context = 'hobby';
                } else if (message.includes('weather') || message.includes('rain') || message.includes('sunny') || message.includes('cold') || message.includes('hot')) {
                    context = 'weather';
                } else if (message.includes('feel') || message.includes('sad') || message.includes('happy') || message.includes('angry') || message.includes('worried')) {
                    context = 'feelings';
                } else if (message.includes('?') || message.includes('what') || message.includes('how') || message.includes('why') || message.includes('when')) {
                    context = 'questions';
                }
                
                // Get appropriate responses for context
                const contextResponses = languageResponses[context] || languageResponses.default;
                
                // Add conversation memory - reference previous topics
                if (conversationLength > 2) {
                    const previousTopics = this.getPreviousTopics();
                    if (previousTopics.length > 0) {
                        const memoryResponses = {
                            'en': [
                                `Speaking of ${previousTopics[0]}, that reminds me of what you said earlier.`,
                                `That's interesting! Earlier you mentioned ${previousTopics[0]}.`,
                                `I remember you talking about ${previousTopics[0]} before. How does this relate?`
                            ],
                            'es': [
                                `Hablando de ${previousTopics[0]}, eso me recuerda lo que dijiste antes.`,
                                `¬°Eso es interesante! Antes mencionaste ${previousTopics[0]}.`,
                                `Recuerdo que hablaste de ${previousTopics[0]} antes. ¬øC√≥mo se relaciona esto?`
                            ],
                            'fr': [
                                `En parlant de ${previousTopics[0]}, cela me rappelle ce que vous avez dit plus t√¥t.`,
                                `C'est int√©ressant ! Plus t√¥t vous avez mentionn√© ${previousTopics[0]}.`,
                                `Je me souviens que vous avez parl√© de ${previousTopics[0]} avant. Comment cela se rapporte-t-il ?`
                            ]
                        };
                        
                        const memoryResponseSet = memoryResponses[this.selectedLanguage.code] || memoryResponses['en'];
                        contextResponses.push(...memoryResponseSet);
                    }
                }
                
                return contextResponses[Math.floor(Math.random() * contextResponses.length)];
            }

            getPreviousTopics() {
                const topics = [];
                const userMessages = this.conversationHistory.filter(msg => msg.role === 'user');
                
                userMessages.forEach(msg => {
                    const content = msg.content.toLowerCase();
                    if (content.includes('work') || content.includes('job')) topics.push('work');
                    if (content.includes('family')) topics.push('family');
                    if (content.includes('travel') || content.includes('trip')) topics.push('travel');
                    if (content.includes('food') || content.includes('eat')) topics.push('food');
                    if (content.includes('hobby') || content.includes('sport')) topics.push('hobbies');
                });
                
                return [...new Set(topics)]; // Remove duplicates
            }

            addMessageToChat(content, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.textContent = content;
                messageDiv.appendChild(contentDiv);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                messageDiv.appendChild(timeDiv);
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            requestEvaluation() {
                if (!this.currentSession || this.conversationHistory.length === 0) {
                    alert('No conversation to evaluate!');
                    return;
                }

                this.statusMessage.textContent = "Analyzing your conversation...";
                this.evaluateBtn.disabled = true;

                // Simulate evaluation (demo mode) - Now with accurate scoring
                setTimeout(() => {
                    const userMessages = this.conversationHistory.filter(msg => msg.role === 'user');
                    
                    // Analyze user messages for common mistakes
                    const mistakes = this.analyzeMistakes(userMessages);
                    
                    // Calculate realistic score based on actual performance
                    const score = this.calculateRealisticScore(userMessages, mistakes);
                    
                    // Generate personalized evaluation based on actual conversation and score
                    const totalWords = userMessages.reduce((sum, msg) => sum + msg.content.split(' ').length, 0);
                    const avgWordsPerMessage = totalWords / userMessages.length;
                    const conversationLength = userMessages.length;
                    
                    // Generate summary based on actual score
                    let summary = this.generateScoreBasedSummary(score, mistakes, conversationLength, avgWordsPerMessage);
                    
                    // Generate strengths based on actual performance
                    const strengths = this.generateRealisticStrengths(score, mistakes, conversationLength, avgWordsPerMessage);
                    
                    // Generate suggestions based on actual mistakes
                    const suggestions = this.generateTargetedSuggestions(mistakes, score);
                    
                    const evaluation = {
                        overall_score: score,
                        summary: summary,
                        strengths: strengths,
                        mistakes: mistakes,
                        suggestions: suggestions,
                        areas_for_improvement: [
                            "Grammar accuracy",
                            "Vocabulary expansion", 
                            "Fluency in speaking",
                            "Conversation flow"
                        ]
                    };

                    this.displayEvaluation(evaluation);
                    this.evaluateBtn.disabled = false;
                }, 2000);
            }

            calculateRealisticScore(userMessages, mistakes) {
                if (userMessages.length === 0) return 0;
                
                let baseScore = 100; // Start with perfect score
                
                // Calculate total words and sentences
                const totalWords = userMessages.reduce((sum, msg) => sum + msg.content.split(' ').length, 0);
                const totalSentences = userMessages.reduce((sum, msg) => sum + msg.content.split(/[.!?]/).length - 1, 0);
                const avgWordsPerMessage = totalWords / userMessages.length;
                
                // Deduct points for actual grammar mistakes
                const grammarMistakes = mistakes.filter(m => 
                    !m.message.includes('Short responses') && 
                    !m.message.includes('Very long responses') && 
                    !m.message.includes('Limited vocabulary variety') &&
                    !m.message.includes('Repetitive sentence structures') &&
                    !m.message.includes('Simple sentence structures')
                );
                
                // Deduct points for grammar mistakes (more severe)
                baseScore -= grammarMistakes.length * 8; // Each grammar mistake = -8 points
                
                // Deduct points for conversation quality issues (less severe)
                const qualityIssues = mistakes.filter(m => 
                    m.message.includes('Short responses') || 
                    m.message.includes('Very long responses') || 
                    m.message.includes('Limited vocabulary variety') ||
                    m.message.includes('Repetitive sentence structures') ||
                    m.message.includes('Simple sentence structures')
                );
                
                baseScore -= qualityIssues.length * 3; // Each quality issue = -3 points
                
                // Additional penalties based on conversation analysis
                
                // Penalty for very short responses
                if (avgWordsPerMessage < 2) {
                    baseScore -= 15;
                } else if (avgWordsPerMessage < 3) {
                    baseScore -= 10;
                } else if (avgWordsPerMessage < 4) {
                    baseScore -= 5;
                }
                
                // Penalty for very long responses (hard to follow)
                if (avgWordsPerMessage > 25) {
                    baseScore -= 10;
                } else if (avgWordsPerMessage > 20) {
                    baseScore -= 5;
                }
                
                // Penalty for very short conversations
                if (userMessages.length < 3) {
                    baseScore -= 10;
                }
                
                // Bonus for good conversation length
                if (userMessages.length >= 5 && avgWordsPerMessage >= 5) {
                    baseScore += 5;
                }
                
                // Bonus for complex sentence structures
                const hasComplexStructures = userMessages.some(msg => 
                    msg.content.includes('because') || msg.content.includes('although') || 
                    msg.content.includes('however') || msg.content.includes('moreover') ||
                    msg.content.includes('therefore') || msg.content.includes('furthermore') ||
                    msg.content.includes('while') || msg.content.includes('since') ||
                    msg.content.includes('unless') || msg.content.includes('whereas')
                );
                
                if (hasComplexStructures) {
                    baseScore += 5;
                }
                
                // Bonus for good vocabulary variety
                const allWords = userMessages.map(msg => msg.content.toLowerCase()).join(' ');
                const uniqueWords = new Set(allWords.split(' ').filter(word => word.length > 2));
                const vocabularyRatio = uniqueWords.size / Math.max(totalWords, 1);
                
                if (vocabularyRatio > 0.7) {
                    baseScore += 5;
                } else if (vocabularyRatio < 0.3) {
                    baseScore -= 10;
                }
                
                // Ensure score is within reasonable bounds
                const finalScore = Math.max(0, Math.min(100, Math.round(baseScore)));
                
                console.log(`Score calculation: Base=100, Grammar mistakes=${grammarMistakes.length} (-${grammarMistakes.length * 8}), Quality issues=${qualityIssues.length} (-${qualityIssues.length * 3}), Final=${finalScore}`);
                
                return finalScore;
            }

            generateScoreBasedSummary(score, mistakes, conversationLength, avgWordsPerMessage) {
                const grammarMistakes = mistakes.filter(m => 
                    !m.message.includes('Short responses') && 
                    !m.message.includes('Very long responses') && 
                    !m.message.includes('Limited vocabulary variety') &&
                    !m.message.includes('Repetitive sentence structures') &&
                    !m.message.includes('Simple sentence structures')
                );
                
                if (score >= 90) {
                    return `Excellent performance! You demonstrated strong ${this.selectedLanguage.name} skills with ${conversationLength} messages averaging ${avgWordsPerMessage.toFixed(1)} words each. ${grammarMistakes.length === 0 ? 'No grammar mistakes were detected.' : `Only ${grammarMistakes.length} minor issue${grammarMistakes.length === 1 ? ' was' : 's were'} found.`}`;
                } else if (score >= 80) {
                    return `Good performance! You showed solid ${this.selectedLanguage.name} skills with ${conversationLength} messages. ${grammarMistakes.length > 0 ? `There were ${grammarMistakes.length} grammar mistake${grammarMistakes.length === 1 ? '' : 's'} that need attention.` : 'Your grammar was mostly accurate.'}`;
                } else if (score >= 70) {
                    return `Fair performance. You completed ${conversationLength} messages in ${this.selectedLanguage.name}, but there were ${grammarMistakes.length} grammar mistake${grammarMistakes.length === 1 ? '' : 's'} and some areas for improvement.`;
                } else if (score >= 60) {
                    return `Below average performance. You had ${conversationLength} messages with ${grammarMistakes.length} grammar mistake${grammarMistakes.length === 1 ? '' : 's'} and several areas that need significant improvement.`;
                } else {
                    return `Poor performance. Your ${this.selectedLanguage.name} conversation had ${grammarMistakes.length} grammar mistake${grammarMistakes.length === 1 ? '' : 's'} and multiple issues that require focused practice and study.`;
                }
            }

            generateRealisticStrengths(score, mistakes, conversationLength, avgWordsPerMessage) {
                const strengths = [];
                const grammarMistakes = mistakes.filter(m => 
                    !m.message.includes('Short responses') && 
                    !m.message.includes('Very long responses') && 
                    !m.message.includes('Limited vocabulary variety') &&
                    !m.message.includes('Repetitive sentence structures') &&
                    !m.message.includes('Simple sentence structures')
                );
                
                if (score >= 80) {
                    if (grammarMistakes.length === 0) strengths.push("Excellent grammar accuracy");
                    if (conversationLength >= 5) strengths.push("Good conversation engagement");
                    if (avgWordsPerMessage >= 8) strengths.push("Detailed and elaborate responses");
                    if (avgWordsPerMessage >= 5 && avgWordsPerMessage <= 15) strengths.push("Appropriate response length");
                    strengths.push("Clear communication style");
                } else if (score >= 60) {
                    if (grammarMistakes.length <= 2) strengths.push("Mostly accurate grammar");
                    if (conversationLength >= 3) strengths.push("Basic conversation skills");
                    if (avgWordsPerMessage >= 4) strengths.push("Adequate response length");
                    strengths.push("Willingness to communicate");
                } else {
                    if (conversationLength >= 2) strengths.push("Attempted communication");
                    strengths.push("Basic vocabulary usage");
                }
                
                return strengths.length > 0 ? strengths : ["Showed effort in practicing"];
            }

            generateTargetedSuggestions(mistakes, score) {
                const suggestions = [];
                const grammarMistakes = mistakes.filter(m => 
                    !m.message.includes('Short responses') && 
                    !m.message.includes('Very long responses') && 
                    !m.message.includes('Limited vocabulary variety') &&
                    !m.message.includes('Repetitive sentence structures') &&
                    !m.message.includes('Simple sentence structures')
                );
                
                // Grammar-specific suggestions
                if (grammarMistakes.length > 0) {
                    suggestions.push("Focus on grammar fundamentals - review basic rules");
                    if (grammarMistakes.some(m => m.message.includes('goed') || m.message.includes('runned'))) {
                        suggestions.push("Study irregular past tense verbs");
                    }
                    if (grammarMistakes.some(m => m.message.includes('a ') && m.message.includes('aeiou'))) {
                        suggestions.push("Practice article usage (a vs an)");
                    }
                    if (grammarMistakes.some(m => m.message.includes('he go') || m.message.includes('she do'))) {
                        suggestions.push("Review subject-verb agreement rules");
                    }
                }
                
                // Quality-specific suggestions
                mistakes.forEach(mistake => {
                    if (mistake.message.includes('Short responses')) {
                        suggestions.push("Try to elaborate more in your responses");
                    }
                    if (mistake.message.includes('Very long responses')) {
                        suggestions.push("Practice breaking long thoughts into shorter, clearer sentences");
                    }
                    if (mistake.message.includes('Limited vocabulary variety')) {
                        suggestions.push("Expand your vocabulary by learning new words and expressions");
                    }
                    if (mistake.message.includes('Repetitive sentence structures')) {
                        suggestions.push("Vary your sentence beginnings and structures");
                    }
                    if (mistake.message.includes('Simple sentence structures')) {
                        suggestions.push("Practice using connecting words (because, although, however)");
                    }
                });
                
                // General suggestions based on score
                if (score < 70) {
                    suggestions.push("Consider taking a basic language course");
                    suggestions.push("Practice with simpler, shorter sentences first");
                } else if (score < 80) {
                    suggestions.push("Continue practicing regularly");
                    suggestions.push("Focus on the specific grammar areas mentioned above");
                } else {
                    suggestions.push("Keep practicing to maintain your current level");
                    suggestions.push("Try more complex conversation topics");
                }
                
                return suggestions.slice(0, 5); // Limit to 5 suggestions
            }

            analyzeMistakes(userMessages) {
                const mistakes = [];
                
                // Analyze actual conversation content for realistic feedback
                userMessages.forEach(msg => {
                    const content = msg.content.toLowerCase();
                    
                    // Check for common mistakes based on actual content
                    if (this.selectedLanguage.code === 'en') {
                        // Comprehensive English mistake detection
                        
                        // Irregular past tense verbs (expanded list)
                        const irregularVerbs = {
                            'goed': 'went', 'runned': 'ran', 'eated': 'ate', 'drinked': 'drank',
                            'sleeped': 'slept', 'writed': 'wrote', 'readed': 'read', 'catched': 'caught',
                            'teached': 'taught', 'buyed': 'bought', 'bringed': 'brought', 'thinked': 'thought',
                            'fighted': 'fought', 'seeked': 'sought', 'builded': 'built', 'feeled': 'felt',
                            'keeped': 'kept', 'leaved': 'left', 'meeted': 'met', 'payed': 'paid',
                            'selled': 'sold', 'telled': 'told', 'winned': 'won', 'costed': 'cost',
                            'cutted': 'cut', 'hitted': 'hit', 'hurted': 'hurt', 'putted': 'put',
                            'shutted': 'shut', 'spreaded': 'spread', 'bursted': 'burst', 'casted': 'cast',
                            'choosed': 'chose', 'drawed': 'drew', 'growed': 'grew', 'knowed': 'knew',
                            'throwed': 'threw', 'flyed': 'flew', 'blowed': 'blew', 'flowed': 'flew',
                            'showed': 'showed', 'sewed': 'sewed', 'mowed': 'mowed', 'sowed': 'sowed'
                        };
                        
                        Object.keys(irregularVerbs).forEach(wrong => {
                            if (content.includes(wrong)) {
                                mistakes.push({
                                    message: wrong,
                                    correction: irregularVerbs[wrong],
                                    explanation: `Past tense of '${wrong.replace('ed', '')}' is '${irregularVerbs[wrong]}', not '${wrong}'`
                                });
                            }
                        });
                        
                        // Article mistakes (a/an)
                        if (content.match(/\ba\s+[aeiou]/)) {
                            const match = content.match(/\ba\s+([aeiou]\w+)/);
                            if (match) {
                                mistakes.push({
                                    message: `a ${match[1]}`,
                                    correction: `an ${match[1]}`,
                                    explanation: "Use 'an' before words starting with vowel sounds"
                                });
                            }
                        }
                        
                        // Subject-verb agreement (expanded)
                        const subjectVerbMistakes = {
                            'he go': 'he goes', 'she go': 'she goes', 'it go': 'it goes',
                            'he do': 'he does', 'she do': 'she does', 'it do': 'it does',
                            'he have': 'he has', 'she have': 'she has', 'it have': 'it has',
                            'he be': 'he is', 'she be': 'she is', 'it be': 'it is',
                            'he can': 'he can', 'she can': 'she can', 'it can': 'it can'
                        };
                        
                        Object.keys(subjectVerbMistakes).forEach(wrong => {
                            if (content.includes(wrong)) {
                                mistakes.push({
                                    message: wrong,
                                    correction: subjectVerbMistakes[wrong],
                                    explanation: "Third person singular requires the correct verb form"
                                });
                            }
                        });
                        
                        // Double negatives
                        if (content.match(/\b(no|not|never|nothing|nobody|nowhere)\s+.*\b(no|not|never|nothing|nobody|nowhere)\b/)) {
                            mistakes.push({
                                message: "Double negative",
                                correction: "Single negative",
                                explanation: "In English, use only one negative word per sentence"
                            });
                        }
                        
                        // Wrong prepositions (expanded)
                        const wrongPrepositions = {
                            'on the morning': 'in the morning', 'in monday': 'on Monday', 
                            'in tuesday': 'on Tuesday', 'in wednesday': 'on Wednesday',
                            'in the table': 'on the table', 'on the room': 'in the room',
                            'depend of': 'depend on', 'different of': 'different from',
                            'good in': 'good at', 'bad in': 'bad at', 'interested on': 'interested in',
                            'afraid from': 'afraid of', 'angry on': 'angry with', 'arrive to': 'arrive at',
                            'believe on': 'believe in', 'care of': 'care about', 'complain on': 'complain about'
                        };
                        
                        Object.keys(wrongPrepositions).forEach(wrong => {
                            if (content.includes(wrong)) {
                                mistakes.push({
                                    message: wrong,
                                    correction: wrongPrepositions[wrong],
                                    explanation: "Check preposition usage - this is a common mistake"
                                });
                            }
                        });
                        
                        // Countable/uncountable nouns
                        const uncountableNouns = ['money', 'water', 'information', 'advice', 'news', 'furniture', 'luggage', 'equipment', 'research', 'evidence'];
                        uncountableNouns.forEach(noun => {
                            if (content.match(new RegExp(`\\bmany\\s+${noun}\\b`))) {
                                mistakes.push({
                                    message: `many ${noun}`,
                                    correction: `much ${noun}`,
                                    explanation: `'${noun}' is uncountable, use 'much' instead of 'many'`
                                });
                            }
                        });
                        
                        // Wrong word order (adverbs)
                        if (content.match(/\b(always|never|often|usually|sometimes)\s+(he|she|it|they)\s+/)) {
                            mistakes.push({
                                message: "Adverb position",
                                correction: "Move adverb after the verb",
                                explanation: "Adverbs of frequency go after the verb 'be' but before other verbs"
                            });
                        }
                        
                        // Wrong verb forms after 'be'
                        const beVerbMistakes = {
                            'am go': 'am going', 'is go': 'is going', 'are go': 'are going',
                            'am do': 'am doing', 'is do': 'is doing', 'are do': 'are doing',
                            'am have': 'am having', 'is have': 'is having', 'are have': 'are having'
                        };
                        
                        Object.keys(beVerbMistakes).forEach(wrong => {
                            if (content.includes(wrong)) {
                                mistakes.push({
                                    message: wrong,
                                    correction: beVerbMistakes[wrong],
                                    explanation: "Use present continuous form after 'be' verbs"
                                });
                            }
                        });
                        
                        // Common word confusions
                        const wordConfusions = {
                            'there is': 'there is', 'there are': 'there are', // These are correct
                            'their is': 'there is', 'their are': 'there are',
                            'your welcome': 'you\'re welcome', 'your right': 'you\'re right',
                            'its a': 'it\'s a', 'its not': 'it\'s not', 'its good': 'it\'s good',
                            'loose weight': 'lose weight', 'loose time': 'lose time',
                            'quite good': 'quite good', 'quiet good': 'quite good'
                        };
                        
                        Object.keys(wordConfusions).forEach(wrong => {
                            if (content.includes(wrong) && wrong !== wordConfusions[wrong]) {
                                mistakes.push({
                                    message: wrong,
                                    correction: wordConfusions[wrong],
                                    explanation: "Check spelling and word choice"
                                });
                            }
                        });
                        
                        // Missing articles
                        if (content.match(/\b(go to|went to|going to)\s+(school|hospital|church|work|home)\b/)) {
                            // This is actually correct - no article needed
                        } else if (content.match(/\b(go to|went to|going to)\s+(the\s+)?(school|hospital|church|work|home)\b/)) {
                            // Check for unnecessary articles
                            const match = content.match(/\b(go to|went to|going to)\s+the\s+(school|hospital|church|work|home)\b/);
                            if (match) {
                                mistakes.push({
                                    message: `the ${match[2]}`,
                                    correction: match[2],
                                    explanation: "No article needed with these specific places"
                                });
                            }
                        }
                    }
                    
                    // Enhanced Spanish mistake detection
                    if (this.selectedLanguage.code === 'es') {
                        // Subject pronoun omission
                        if (content.includes('yo soy muy bueno') || content.includes('yo soy muy buena')) {
                            mistakes.push({
                                message: "yo soy muy bueno/buena",
                                correction: "soy muy bueno/buena",
                                explanation: "Subject pronoun 'yo' is usually omitted in Spanish"
                            });
                        }
                        
                        // Gender agreement
                        const genderMistakes = {
                            'la chico': 'el chico', 'la hombre': 'el hombre', 'la padre': 'el padre',
                            'la hermano': 'el hermano', 'el chica': 'la chica', 'el mujer': 'la mujer',
                            'el madre': 'la madre', 'el hermana': 'la hermana'
                        };
                        
                        Object.keys(genderMistakes).forEach(wrong => {
                            if (content.includes(wrong)) {
                                mistakes.push({
                                    message: wrong,
                                    correction: genderMistakes[wrong],
                                    explanation: "Use correct gender agreement with articles and nouns"
                                });
                            }
                        });
                        
                        // Ser vs Estar confusion
                        if (content.includes('soy en casa') || content.includes('soy en el trabajo')) {
                            mistakes.push({
                                message: "soy en",
                                correction: "estoy en",
                                explanation: "Use 'estar' for location, not 'ser'"
                            });
                        }
                    }
                    
                    // Enhanced French mistake detection
                    if (this.selectedLanguage.code === 'fr') {
                        // Gender agreement
                        if (content.includes('je suis tr√®s bon')) {
                            mistakes.push({
                                message: "je suis tr√®s bon",
                                correction: "je suis tr√®s bon (masculine) or je suis tr√®s bonne (feminine)",
                                explanation: "Adjective must agree with the gender of the speaker"
                            });
                        }
                        
                        // Article gender mistakes
                        const frenchGenderMistakes = {
                            'le fille': 'la fille', 'le femme': 'la femme', 'le m√®re': 'la m√®re',
                            'la gar√ßon': 'le gar√ßon', 'la homme': 'le homme', 'la p√®re': 'le p√®re'
                        };
                        
                        Object.keys(frenchGenderMistakes).forEach(wrong => {
                            if (content.includes(wrong)) {
                                mistakes.push({
                                    message: wrong,
                                    correction: frenchGenderMistakes[wrong],
                                    explanation: "Use correct gender agreement with articles and nouns"
                                });
                            }
                        });
                        
                        // Contractions
                        if (content.includes('je ai') || content.includes('tu as') || content.includes('il a')) {
                            mistakes.push({
                                message: "je ai / tu as / il a",
                                correction: "j'ai / tu as / il a",
                                explanation: "Use contractions with 'avoir' in first person"
                            });
                        }
                    }
                });

                // Enhanced conversation quality analysis
                if (mistakes.length === 0 && userMessages.length > 2) {
                    const totalWords = userMessages.reduce((sum, msg) => sum + msg.content.split(' ').length, 0);
                    const avgWordsPerMessage = totalWords / userMessages.length;
                    
                    // Response length analysis
                    if (avgWordsPerMessage < 3) {
                        mistakes.push({
                            message: "Very short responses",
                            correction: "Try longer, more detailed responses",
                            explanation: "Your responses are quite short. Try to elaborate more to practice complex sentence structures and vocabulary."
                        });
                    } else if (avgWordsPerMessage > 20) {
                        mistakes.push({
                            message: "Very long responses",
                            correction: "Consider breaking into shorter sentences",
                            explanation: "Your responses are quite long. Try breaking them into shorter, clearer sentences for better communication."
                        });
                    }
                    
                    // Vocabulary variety analysis
                    const allWords = userMessages.map(msg => msg.content.toLowerCase()).join(' ');
                    const uniqueWords = new Set(allWords.split(' ').filter(word => word.length > 2));
                    if (uniqueWords.size < userMessages.length * 1.5) {
                        mistakes.push({
                            message: "Limited vocabulary variety",
                            correction: "Use more diverse vocabulary",
                            explanation: "Try using different words and expressions to expand your vocabulary range and make your speech more interesting."
                        });
                    }
                    
                    // Sentence structure variety
                    const sentences = userMessages.map(msg => msg.content.split(/[.!?]/)).flat();
                    const sentenceStarts = sentences.map(s => s.trim().split(' ')[0]).filter(s => s.length > 0);
                    const uniqueStarts = new Set(sentenceStarts);
                    if (uniqueStarts.size < Math.min(sentenceStarts.length, 4)) {
                        mistakes.push({
                            message: "Repetitive sentence structures",
                            correction: "Vary your sentence beginnings",
                            explanation: "Try starting sentences with different words (However, Moreover, Additionally, etc.) to make your speech more natural and engaging."
                        });
                    }
                    
                    // Grammar complexity analysis
                    const complexStructures = userMessages.some(msg => 
                        msg.content.includes('because') || msg.content.includes('although') || 
                        msg.content.includes('however') || msg.content.includes('moreover') ||
                        msg.content.includes('therefore') || msg.content.includes('furthermore')
                    );
                    
                    if (!complexStructures && userMessages.length > 4) {
                        mistakes.push({
                            message: "Simple sentence structures",
                            correction: "Use more complex sentence structures",
                            explanation: "Try using connecting words like 'because', 'although', 'however' to create more sophisticated sentences."
                        });
                    }
                }

                return mistakes;
            }

            displayEvaluation(evaluation) {
                const score = evaluation.overall_score || 0;
                const summary = evaluation.summary || 'No summary available.';
                const strengths = evaluation.strengths || [];
                const mistakes = evaluation.mistakes || [];
                const suggestions = evaluation.suggestions || [];
                const improvements = evaluation.areas_for_improvement || [];

                this.evaluationContent.innerHTML = `
                    <div class="score-display">
                        <div class="score-circle">
                            <div class="score-number">${score}</div>
                            <div class="score-label">Overall Score</div>
                        </div>
                    </div>

                    <div>
                        <h3>üìù Summary</h3>
                        <p>${summary}</p>
                    </div>

                    ${strengths.length > 0 ? `
                    <div>
                        <h3>‚úÖ Strengths</h3>
                        <ul>
                            ${strengths.map(strength => `<li>${strength}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    ${mistakes.length > 0 ? `
                    <div>
                        <h3>‚ùå Mistakes & Corrections</h3>
                        ${mistakes.map(mistake => `
                            <div class="mistake-item">
                                <div class="mistake-original">‚ùå "${mistake.message}"</div>
                                <div class="mistake-correction">‚úÖ "${mistake.correction}"</div>
                                <div class="mistake-explanation">${mistake.explanation || 'No explanation provided.'}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : '<div><h3>üéâ No mistakes found! Great job!</h3></div>'}

                    ${suggestions.length > 0 ? `
                    <div>
                        <h3>üí° Suggestions</h3>
                        <ul>
                            ${suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    ${improvements.length > 0 ? `
                    <div>
                        <h3>üéØ Areas for Improvement</h3>
                        <ul>
                            ${improvements.map(area => `<li>${area}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                `;

                this.statusMessage.textContent = `Evaluation complete! Score: ${score}/100`;
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new LanguageTeacherDemo();
        });
    </script>
</body>
</html>
